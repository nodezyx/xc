const { cmd } = require('../command');
const config = require('../config');
const { setConfig, getConfig } = require("../lib/configdb");
const { exec } = require('child_process');
const os = require('os');
const fs = require('fs');
const path = require('path');

// Utility function to check if buttons should be used
function shouldUseButtons() {
    const buttonStatus = getConfig("BUTTON") || config.BUTTON || "false";
    return buttonStatus === "true" || buttonStatus === true;
}

// Settings menu command with list feature
cmd({
    pattern: "settings",
    alias: ["setting", "config", "cfg"],
    react: "‚öôÔ∏è",
    desc: "Bot settings and configuration menu",
    category: "settings",
    filename: __filename,
}, async (conn, mek, m, { from, isOwner, reply }) => {
    if (!isOwner) return reply("*üìõ Only the owner can use this command!*");

    const useButtons = shouldUseButtons();
    
    if (useButtons) {
        // Button-based settings menu with list feature
        try {
            // Get current status of all settings
            const settings = {
                MODE: getConfig("MODE") || config.MODE || "public",
                BUTTON: getConfig("BUTTON") || config.BUTTON || "false",
                HEARTREACT: getConfig("HEARTREACT") || config.HEARTREACT || "false",
                AUTOTYPING: getConfig("AUTOTYPING") || config.AUTOTYPING || "false",
                ALWAYSONLINE: getConfig("ALWAYSONLINE") || config.ALWAYSONLINE || "false",
                AUTORECORDING: getConfig("AUTORECORDING") || config.AUTORECORDING || "false",
                AUTOSTATUSREACT: getConfig("AUTOSTATUSREACT") || config.AUTOSTATUSREACT || "false",
                AUTOSTATUSSEEN: getConfig("AUTOSTATUSSEEN") || config.AUTOSTATUSSEEN || "false",
                ANTICALL: getConfig("ANTICALL") || config.ANTICALL || "false",
                ANTIBADWORD: getConfig("ANTIBADWORD") || config.ANTIBADWORD || "false",
                AUTOSTICKER: getConfig("AUTOSTICKER") || config.AUTOSTICKER || "false",
                AUTOREPLY: getConfig("AUTOREPLY") || config.AUTOREPLY || "false",
                AUTOREACT: getConfig("AUTOREACT") || config.AUTOREACT || "false",
                AUTOSTATUSREPLY: getConfig("AUTOSTATUSREPLY") || config.AUTOSTATUSREPLY || "false",
                ANTILINK: getConfig("ANTILINK") || config.ANTILINK || "false",
                ANTIBOT: getConfig("ANTIBOT") || config.ANTIBOT || "false"
            };

            // Get bot uptime
            const startTime = global.socketCreationTime || Date.now();
            const uptimeMs = Date.now() - startTime;
            const hours = Math.floor(uptimeMs / 3600000);
            const minutes = Math.floor((uptimeMs % 3600000) / 60000);
            const seconds = Math.floor((uptimeMs % 60000) / 1000);
            const uptime = `${hours}h ${minutes}m ${seconds}s`;
            
            // Get memory usage
            const memoryUsage = process.memoryUsage();
            const ramUsed = Math.round(memoryUsage.heapUsed / 1024 / 1024);
            const ramTotal = Math.round(memoryUsage.heapTotal / 1024 / 1024);
            
            // Get user's pushname
            let pushname = 'Owner';
            try {
                const userJid = conn.user.id;
                pushname = conn.user.name || 'Owner';
            } catch (error) {
                console.error('Failed to get user name:', error);
            }

            await conn.sendMessage(from, {
                buttons: [
                    {
                        buttonId: 'settings-action',
                        buttonText: {
                            displayText: '‚öôÔ∏è Configure Settings'
                        },
                        type: 4,
                        nativeFlowInfo: {
                            name: 'single_select',
                            paramsJson: JSON.stringify({
                                title: 'SUBZERO BOT SETTINGS',
                                sections: [
                                    {
                                        title: 'üîß Bot Configuration',
                                        highlight_label: 'Settings Menu',
                                        rows: [
                                            {
                                                title: `üåê Mode: ${settings.MODE.toUpperCase()}`,
                                                description: 'Set bot to public or private mode',
                                                id: `${config.PREFIX}mode`,
                                            },
                                            {
                                                title: `üîò Buttons: ${settings.BUTTON === "true" ? '‚úÖ ON' : '‚ùå OFF'}`,
                                                description: 'Enable/disable interactive buttons',
                                                id: `${config.PREFIX}buttons`,
                                            },
                                            {
                                                title: `‚ù§Ô∏è Heart React: ${settings.HEARTREACT === "true" ? '‚úÖ ON' : '‚ùå OFF'}`,
                                                description: 'Enable/disable heart reactions',
                                                id: `${config.PREFIX}heartreact`,
                                            },
                                            {
                                                title: `ü´ü Auto Typing: ${settings.AUTOTYPING === "true" ? '‚úÖ ON' : '‚ùå OFF'}`,
                                                description: 'Enable/disable auto typing indicator',
                                                id: `${config.PREFIX}autotyping`,
                                            },
                                            {
                                                title: `üåê Always Online: ${settings.ALWAYSONLINE === "true" ? '‚úÖ ON' : '‚ùå OFF'}`,
                                                description: 'Set bot to always show online',
                                                id: `${config.PREFIX}alwaysonline`,
                                            },
                                            {
                                                title: `üéôÔ∏è Auto Recording: ${settings.AUTORECORDING === "true" ? '‚úÖ ON' : '‚ùå OFF'}`,
                                                description: 'Enable/disable auto recording',
                                                id: `${config.PREFIX}autorecording`,
                                            },
                                            {
                                                title: `üìñ Auto Read Status: ${settings.AUTOSTATUSREACT === "true" ? '‚úÖ ON' : '‚ùå OFF'}`,
                                                description: 'Enable/disable auto status reading',
                                                id: `${config.PREFIX}autostatusreact`,
                                            },
                                            {
                                                title: `üëÄ Auto View Status: ${settings.AUTOSTATUSSEEN === "true" ? '‚úÖ ON' : '‚ùå OFF'}`,
                                                description: 'Enable/disable auto status viewing',
                                                id: `${config.PREFIX}autostatusview`,
                                            },
                                            {
                                                title: `üìû Anti Call: ${settings.ANTICALL === "true" ? '‚úÖ ON' : '‚ùå OFF'}`,
                                                description: 'Enable/disable anti-call feature',
                                                id: `${config.PREFIX}anticall`,
                                            },
                                            {
                                                title: `üö´ Anti Bad Words: ${settings.ANTIBADWORD === "true" ? '‚úÖ ON' : '‚ùå OFF'}`,
                                                description: 'Enable/disable anti-bad words',
                                                id: `${config.PREFIX}antibad`,
                                            },
                                            {
                                                title: `üñºÔ∏è Auto Sticker: ${settings.AUTOSTICKER === "true" ? '‚úÖ ON' : '‚ùå OFF'}`,
                                                description: 'Enable/disable auto sticker conversion',
                                                id: `${config.PREFIX}autosticker`,
                                            },
                                            {
                                                title: `üí¨ Auto Reply: ${settings.AUTOREPLY === "true" ? '‚úÖ ON' : '‚ùå OFF'}`,
                                                description: 'Enable/disable auto reply',
                                                id: `${config.PREFIX}autoreply`,
                                            },
                                            {
                                                title: `‚ù§Ô∏è Auto React: ${settings.AUTOREACT === "true" ? '‚úÖ ON' : '‚ùå OFF'}`,
                                                description: 'Enable/disable auto reactions',
                                                id: `${config.PREFIX}autoreact`,
                                            },
                                            {
                                                title: `üì¢ Status Reply: ${settings.AUTOSTATUSREPLY === "true" ? '‚úÖ ON' : '‚ùå OFF'}`,
                                                description: 'Enable/disable auto status replies',
                                                id: `${config.PREFIX}autostatusreply`,
                                            },
                                            {
                                                title: `üîó Anti Link: ${settings.ANTILINK === "true" ? '‚úÖ ON' : '‚ùå OFF'}`,
                                                description: 'Enable/disable anti-link feature',
                                                id: `${config.PREFIX}antilink`,
                                            },
                                            {
                                                title: `ü§ñ Anti Bot: ${settings.ANTIBOT === "true" ? '‚úÖ ON' : '‚ùå OFF'}`,
                                                description: 'Enable/disable anti-bot feature',
                                                id: `${config.PREFIX}antibot`,
                                            }
                                        ],
                                    },
                                ],
                            }),
                        },
                    },
                ],
                headerType: 1,
                image: { url: "https://mrfrankk-cdn.hf.space/mrfrank/mini/settings.png" },
                caption: formatMessage(
                    'üéÄ ùêíùêîùêÅùêôùêÑùêëùêé ùêíùêÑùêìùêìùêàùêçùêÜùêí üéÄ',
                    `*‚ï≠‚îÄ„Äå BOT INFORMATION „Äç*
*‚îÇ*üîÆ *\`Bot:\`* s·¥ú ô·¥¢·¥á Ä·¥è ·¥ç·¥Ö ·¥ç…™…¥…™ „ÉÉ
*‚îÇ*üë§ *\`User:\`* ${pushname}
*‚îÇ*üß© *\`Owner:\`* ·¥ç Ä “ì Ä·¥Ä…¥·¥ã ·¥è“ì·¥Ñ
*‚îÇ*‚è∞ *\`Uptime:\`* ${uptime}
*‚îÇ*üìÇ *\`Ram:\`* ${ramUsed}MB / ${ramTotal}MB
*‚îÇ*üéê *\`Prefix:\`* ${config.PREFIX}
‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ·êß·êß·êß

*\`Œû\` Select a setting to configure:*`,
                    '¬© ùòæùôßùôöùôñùô©ùôöùôô ùòΩùôÆ ùôàùôß ùôÅùôßùôñùô£ùô† ùôäùôÅùòæ „ÉÉ'
                )
            }, { quoted: mek });

        } catch (error) {
            console.error('Settings menu error:', error);
            await showTextSettings();
        }
    } else {
        await showTextSettings();
    }

    async function showTextSettings() {
        const settings = {
            MODE: getConfig("MODE") || config.MODE || "public",
            BUTTON: getConfig("BUTTON") || config.BUTTON || "false",
            HEARTREACT: getConfig("HEARTREACT") || config.HEARTREACT || "false",
            AUTOTYPING: getConfig("AUTOTYPING") || config.AUTOTYPING || "false",
            ALWAYSONLINE: getConfig("ALWAYSONLINE") || config.ALWAYSONLINE || "false",
            AUTORECORDING: getConfig("AUTORECORDING") || config.AUTORECORDING || "false",
            AUTOSTATUSREACT: getConfig("AUTOSTATUSREACT") || config.AUTOSTATUSREACT || "false",
            AUTOSTATUSSEEN: getConfig("AUTOSTATUSSEEN") || config.AUTOSTATUSSEEN || "false",
            ANTICALL: getConfig("ANTICALL") || config.ANTICALL || "false",
            ANTIBADWORD: getConfig("ANTIBADWORD") || config.ANTIBADWORD || "false",
            AUTOSTICKER: getConfig("AUTOSTICKER") || config.AUTOSTICKER || "false",
            AUTOREPLY: getConfig("AUTOREPLY") || config.AUTOREPLY || "false",
            AUTOREACT: getConfig("AUTOREACT") || config.AUTOREACT || "false",
            AUTOSTATUSREPLY: getConfig("AUTOSTATUSREPLY") || config.AUTOSTATUSREPLY || "false",
            ANTILINK: getConfig("ANTILINK") || config.ANTILINK || "false",
            ANTIBOT: getConfig("ANTIBOT") || config.ANTIBOT || "false"
        };

        const settingsList = `
üéÄ *ùêíùêîùêÅùêôùêÑùêëùêé ùêíùêÑùêìùêìùêàùêçùêÜùêí* üéÄ

*‚ï≠‚îÄ„Äå CURRENT STATUS „Äç‚îÄ*
*‚îÇ* üåê Mode: *${settings.MODE.toUpperCase()}*
*‚îÇ* üîò Buttons: *${settings.BUTTON === "true" ? '‚úÖ ON' : '‚ùå OFF'}*
*‚îÇ* ‚ù§Ô∏è Heart React: *${settings.HEARTREACT === "true" ? '‚úÖ ON' : '‚ùå OFF'}*
*‚îÇ* ü´ü Auto Typing: *${settings.AUTOTYPING === "true" ? '‚úÖ ON' : '‚ùå OFF'}*
*‚îÇ* üåê Always Online: *${settings.ALWAYSONLINE === "true" ? '‚úÖ ON' : '‚ùå OFF'}*
*‚îÇ* üéôÔ∏è Auto Recording: *${settings.AUTORECORDING === "true" ? '‚úÖ ON' : '‚ùå OFF'}*
*‚îÇ* üìñ Auto Read Status: *${settings.AUTOSTATUSREACT === "true" ? '‚úÖ ON' : '‚ùå OFF'}*
*‚îÇ* üëÄ Auto View Status: *${settings.AUTOSTATUSSEEN === "true" ? '‚úÖ ON' : '‚ùå OFF'}*
*‚îÇ* üìû Anti Call: *${settings.ANTICALL === "true" ? '‚úÖ ON' : '‚ùå OFF'}*
*‚îÇ* üö´ Anti Bad Words: *${settings.ANTIBADWORD === "true" ? '‚úÖ ON' : '‚ùå OFF'}*
*‚îÇ* üñºÔ∏è Auto Sticker: *${settings.AUTOSTICKER === "true" ? '‚úÖ ON' : '‚ùå OFF'}*
*‚îÇ* üí¨ Auto Reply: *${settings.AUTOREPLY === "true" ? '‚úÖ ON' : '‚ùå OFF'}*
*‚îÇ* ‚ù§Ô∏è Auto React: *${settings.AUTOREACT === "true" ? '‚úÖ ON' : '‚ùå OFF'}*
*‚îÇ* üì¢ Status Reply: *${settings.AUTOSTATUSREPLY === "true" ? '‚úÖ ON' : '‚ùå OFF'}*
*‚îÇ* üîó Anti Link: *${settings.ANTILINK === "true" ? '‚úÖ ON' : '‚ùå OFF'}*
*‚îÇ* ü§ñ Anti Bot: *${settings.ANTIBOT === "true" ? '‚úÖ ON' : '‚ùå OFF'}*
*‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*

*üìù Usage:*
‚Ä¢ Use *.mode public* to change mode
‚Ä¢ Use *.buttons on* to enable buttons
‚Ä¢ Use *.heartreact off* to disable heart react
‚Ä¢ etc...

*üí° Example:* \`${config.PREFIX}mode private\`
*üí° Example:* \`${config.PREFIX}buttons on\`

¬© ùòæùôßùôöùôñùô©ùôöùôô ùòΩùôÆ ùôàùôß ùôÅùôßùôñùô£ùô† ùôäùôÅùòæ „ÉÉ
`;

        await conn.sendMessage(from, {
            image: { url: 'https://mrfrankk-cdn.hf.space/mrfrank/mini/settings.png' },
            caption: settingsList
        }, { quoted: mek });
    }
});

// Helper function to format message (similar to your menu example)
function formatMessage(title, body, footer) {
    return `${title}\n\n${body}\n\n${footer}`;
}

// Initialize global socket creation time if not exists
if (!global.socketCreationTime) {
    global.socketCreationTime = Date.now();
}

module.exports = { shouldUseButtons };
